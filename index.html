<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cartmills Animal Rescue â€“ Tracker</title>

<style>
  :root{
    color-scheme: light;
    --bg:#f6f8fb; --panel:#fff; --panel2:#f0f4ff;
    --text:#0f172a; --muted:#475569; --border:rgba(15,23,42,.14);
    --brand:#2b6cb0; --brand2:#1f4f85; --danger:#ef4444;
    --shadow:0 10px 24px rgba(15,23,42,.10); --r:14px;
  }
  html[data-theme="dark"]{
    color-scheme: dark;
    --bg:#0b1220; --panel:#0f172a; --panel2:#0b2a4d;
    --text:#e5e7eb; --muted:#a3b1c6; --border:rgba(229,231,235,.14);
    --shadow:0 10px 24px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
  .sidebar{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;padding:14px;position:sticky;top:0;height:100vh;overflow:auto}
  html[data-theme="dark"] .sidebar{background:linear-gradient(180deg,#0b2a4d,#061a31)}
  .brand{display:flex;gap:10px;align-items:center;padding:10px 10px 14px}
  .logo{width:38px;height:38px;border-radius:12px;background:rgba(255,255,255,.16);display:flex;align-items:center;justify-content:center;font-weight:900}
  .brand h1{font-size:15px;margin:0;line-height:1.2}
  .brand p{margin:2px 0 0;opacity:.9;font-size:12px}
  .top-actions{display:flex;gap:8px;padding:0 10px 10px}
  .iconbtn{flex:1;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;border-radius:12px;padding:10px;cursor:pointer;font-weight:700;font-size:12px}
  .iconbtn:hover{background:rgba(255,255,255,.16)}
  .nav{display:flex;flex-direction:column;gap:6px;padding:6px 8px 14px}
  .nav button{width:100%;border:0;border-radius:12px;background:transparent;color:rgba(255,255,255,.92);padding:11px 12px;text-align:left;cursor:pointer;font-size:14px;font-weight:750;display:flex;justify-content:space-between;align-items:center}
  .nav button:hover{background:rgba(255,255,255,.12)}
  .nav button.active{background:rgba(255,255,255,.22);outline:2px solid rgba(255,255,255,.18)}
  .main{padding:18px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
  .title h2{margin:0;font-size:18px}
  .title small{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
  .card h3{margin:0 0 10px;font-size:16px}
  .sub{color:var(--muted);margin:-6px 0 12px;font-size:13px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .field{grid-column:span 6}
  .field.sm{grid-column:span 3}
  .field.md{grid-column:span 4}
  .field.lg{grid-column:span 8}
  .field.full{grid-column:span 12}
  label{display:block;font-size:12px;color:var(--muted);font-weight:800;margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none}
  textarea{min-height:90px;resize:vertical}
  .btnrow{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .btn{border:0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:900}
  .btn.primary{background:var(--brand);color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.danger{background:var(--danger);color:#fff}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--panel2);border:1px solid var(--border);font-size:12px;font-weight:900}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{border-radius:14px;border:1px solid var(--border);padding:12px;background:rgba(255,255,255,.35)}
  html[data-theme="dark"] .item{background:rgba(255,255,255,.04)}
  .item h4{margin:0 0 6px}
  .muted{color:var(--muted);font-size:13px}
  .hr{height:1px;background:var(--border);margin:10px 0}
  section{display:none}
  section.active{display:block}

  .overlay{position:fixed;inset:0;background:rgba(2,6,23,.65);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .overlay.show{display:flex}
  .modal{width:min(520px,100%);background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px;color:var(--text)}

  @media (max-width:980px){
    .app{grid-template-columns:1fr}
    .sidebar{position:relative;height:auto}
  }
</style>
</head>

<body>
<div class="app" id="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">CA</div>
      <div>
        <h1 id="brandName">Cartmills Animal Rescue</h1>
        <p id="brandSub">Shared Tracker</p>
      </div>
    </div>

    <div class="top-actions">
      <button class="iconbtn" id="btnTheme">ðŸŒ™ Theme</button>
      <button class="iconbtn" id="btnSync">âŸ³ Sync</button>
    </div>

    <nav class="nav" id="nav">
      <button class="active" data-section="dashboard"><span class="label">Dashboard</span><span>â€º</span></button>
      <button data-section="animals_list"><span class="label">Animals â€“ List</span><span>â€º</span></button>
      <button data-section="animals_add"><span class="label">Animals â€“ Add</span><span>â€º</span></button>
      <button data-section="fosters"><span class="label">Fosters</span><span>â€º</span></button>
      <button data-section="vets"><span class="label">Vets</span><span>â€º</span></button>
      <button data-section="pounds"><span class="label">Pounds</span><span>â€º</span></button>
      <button data-section="calendar"><span class="label">Calendar</span><span>â€º</span></button>
      <button data-section="accounting"><span class="label">Accounting</span><span>â€º</span></button>
      <button data-section="rescue"><span class="label">Rescue Info</span><span>â€º</span></button>

      <button id="logoutBtn" class="iconbtn" style="margin-top:10px;border-color:rgba(255,255,255,.35)">â†© Logout</button>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title">
        <h2 id="pageTitle">Dashboard</h2>
        <small id="pageHint">Shared database via Google Sheets.</small>
      </div>
      <div class="muted" id="syncStatus"></div>
    </div>

    <section id="section-dashboard" class="active">
      <div class="grid">
        <div class="card" style="grid-column:span 12;">
          <h3>Dashboard</h3>
          <p class="sub">If tabs were not clickable before, it was a JavaScript syntax error. This file fixes it.</p>
          <div class="row">
            <div class="field md"><div class="pill">Animals: <span id="dashTotal">0</span></div></div>
            <div class="field md"><div class="pill">In foster: <span id="dashFoster">0</span></div></div>
            <div class="field md"><div class="pill">Adopted: <span id="dashAdopted">0</span></div></div>
          </div>
          <div class="hr"></div>
          <div class="btnrow">
            <button class="btn ghost" id="btnExport">Download Backup (JSON)</button>
            <button class="btn ghost" id="btnImport">Import Backup (JSON)</button>
          </div>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>

        <div class="card" style="grid-column:span 12;">
          <h3>Newest animals</h3>
          <p class="sub">Latest 10 added.</p>
          <div id="dashNewest" class="list"></div>
        </div>
      </div>
    </section>

    <section id="section-animals_list">
      <div class="card">
        <h3>Animals â€“ List</h3>
        <p class="sub">Click Edit to update a record.</p>
        <div id="animalsList" class="list"></div>
      </div>
    </section>

    <section id="section-animals_add">
      <div class="card">
        <h3>Animals â€“ Add</h3>
        <p class="sub">Unique code auto-generated: Dog = D####, Cat = C####</p>
        <div class="row">
          <div class="field md">
            <label>Species</label>
            <select id="aSpecies">
              <option value="">Selectâ€¦</option>
              <option value="dog">Dog</option>
              <option value="cat">Cat</option>
            </select>
          </div>
          <div class="field md">
            <label>Unique Code</label>
            <input id="aCode" readonly />
          </div>
          <div class="field md">
            <label>Name (optional)</label>
            <input id="aName" placeholder="e.g., Daisy" />
          </div>
          <div class="field md">
            <label>Date Rescued</label>
            <input id="aRescued" type="date" />
          </div>
          <div class="field md">
            <label>Sex</label>
            <select id="aSex">
              <option value="">Selectâ€¦</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
          <div class="field md">
            <label>Colour</label>
            <input id="aColour" maxlength="40" />
          </div>
          <div class="field md">
            <label>Location</label>
            <select id="aLocation">
              <option value="">Selectâ€¦</option>
              <option value="pound">Pound</option>
              <option value="foster">Foster</option>
              <option value="adopted">Adopted</option>
              <option value="transport">Transport</option>
            </select>
          </div>
          <div class="field full">
            <label>Notes</label>
            <textarea id="aNotes" placeholder="Medical notes, temperament, etc."></textarea>
          </div>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnSaveAnimal">Save Animal</button>
          <button class="btn ghost" id="btnClearAnimal">Clear</button>
        </div>
      </div>
    </section>

    <section id="section-fosters">
      <div class="card">
        <h3>Fosters</h3>
        <div class="row">
          <div class="field md"><label>Name</label><input id="fName"></div>
          <div class="field md"><label>Phone</label><input id="fPhone"></div>
          <div class="field full"><label>Address</label><input id="fAddress"></div>
          <div class="field sm"><label>Capacity</label><input id="fCap" type="number" min="0"></div>
          <div class="field sm"><label>Hosting</label><input id="fHosting" type="number" min="0" value="0"></div>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnSaveFoster">Save Foster</button>
        </div>
        <div class="hr"></div>
        <div id="fosterList" class="list"></div>
      </div>
    </section>

    <section id="section-vets">
      <div class="card">
        <h3>Vets</h3>
        <div class="row">
          <div class="field md"><label>Clinic Name</label><input id="vName"></div>
          <div class="field md"><label>Phone</label><input id="vPhone"></div>
          <div class="field full"><label>Address</label><input id="vAddress"></div>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnSaveVet">Save Vet</button>
        </div>
        <div class="hr"></div>
        <div id="vetList" class="list"></div>
      </div>
    </section>

    <section id="section-pounds">
      <div class="card">
        <h3>Pounds</h3>
        <div class="row">
          <div class="field md"><label>Pound Name</label><input id="pName"></div>
          <div class="field md"><label>Best Contact</label><input id="pContact"></div>
          <div class="field full"><label>Address</label><input id="pAddress"></div>
          <div class="field md"><label>Estimated Euthanasia Day</label><input id="pEuth" type="date"></div>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnSavePound">Save Pound</button>
        </div>
        <div class="hr"></div>
        <div id="poundList" class="list"></div>
      </div>
    </section>

    <section id="section-calendar">
      <div class="card">
        <h3>Calendar</h3>
        <div class="row">
          <div class="field md"><label>Date</label><input id="cDate" type="date"></div>
          <div class="field lg"><label>Reminder / Vet Booking</label><input id="cNote"></div>
          <div class="field md">
            <label>Status</label>
            <select id="cStatus"><option value="booked">Booked</option><option value="completed">Completed</option></select>
          </div>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnAddCal">Add</button>
        </div>
        <div class="hr"></div>
        <div id="calendarList" class="list"></div>
      </div>
    </section>

    <section id="section-accounting">
      <div class="card">
        <h3>Accounting</h3>
        <div class="row">
          <div class="field md"><label>Date</label><input id="accDate" type="date"></div>
          <div class="field lg"><label>Description</label><input id="accDesc"></div>
          <div class="field md">
            <label>Category</label>
            <select id="accCat"><option>Vet</option><option>Food</option><option>Transport</option><option>Supplies</option><option>Admin</option><option>Other</option></select>
          </div>
          <div class="field md"><label>Amount ($)</label><input id="accAmt" type="number" step="0.01"></div>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnAddExpense">Add Expense</button>
        </div>
        <div class="hr"></div>
        <div class="pill">Running Total: $<span id="accTotal">0.00</span></div>
        <div class="hr"></div>
        <div id="expenseList" class="list"></div>
      </div>
    </section>

    <section id="section-rescue">
      <div class="card">
        <h3>Rescue Info</h3>
        <p class="sub">This updates the title/branding. Saved into the shared sheet too.</p>
        <div class="row">
          <div class="field md"><label>Rescue Name</label><input id="rName"></div>
          <div class="field md"><label>Contact Email</label><input id="rEmail"></div>
          <div class="field full"><label>Notes</label><textarea id="rNotes"></textarea></div>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnSaveRescue">Save Rescue Info</button>
        </div>
      </div>
    </section>

    <section id="section-animals_edit">
      <div class="card">
        <h3>Animals â€“ Edit</h3>
        <p class="sub">Edit selected animal.</p>
        <div id="editWrap" class="muted">No animal selected.</div>
      </div>
    </section>

  </main>
</div>

<!-- Login overlay -->
<div class="overlay" id="loginOverlay">
  <div class="modal">
    <h3 id="loginTitle">Login</h3>
    <p class="muted" id="loginHint">Admin is <b>admin/admin</b>. Staff default password is <b>Helper123</b> (forced change).</p>

    <div id="loginForm">
      <div class="row">
        <div class="field full"><label>Email / Username</label><input id="loginEmail" placeholder="admin"></div>
        <div class="field full"><label>Password</label><input id="loginPw" type="password" placeholder="admin"></div>
      </div>
      <div class="btnrow">
        <button class="btn primary" id="btnLogin">Login</button>
      </div>
    </div>

    <div id="pwChange" style="display:none">
      <div class="row">
        <div class="field full"><label>New Password</label><input id="pw1" type="password"></div>
        <div class="field full"><label>Confirm Password</label><input id="pw2" type="password"></div>
      </div>
      <div class="btnrow">
        <button class="btn primary" id="btnChangePw">Save New Password</button>
      </div>
    </div>

    <div class="hr"></div>
    <div class="muted" id="adminArea" style="display:none"></div>
  </div>
</div>

<script>
/* =========================================================
   CONFIG (Shared DB via Google Sheets Apps Script Web App)
   ========================================================= */
// IMPORTANT: keep these 3 OUTSIDE of any object literal (this was your bug).
const CAR_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbycEcZSNa6pWX7MbcB1Kvm0njfKlG_tYhNVOtq11bN1wlTQmKhdgsV3eV1NkLVxA2nF/exec";
const CAR_SLUG = "cartmills";
const CAR_TOKEN = "Cartmills2026"; // change later (donâ€™t share publicly)

/* =========================================================
   Storage helpers (localStorage + auto-save to shared DB)
   ========================================================= */
const LS = {
  get(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  },
  set(key, val){
    localStorage.setItem(key, JSON.stringify(val));
    CAR_scheduleSave();
  }
};

const SS = {
  get(key, fallback){
    try { return JSON.parse(sessionStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  },
  set(key, val){ sessionStorage.setItem(key, JSON.stringify(val)); },
  del(key){ sessionStorage.removeItem(key); }
};

const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
const todayISO = () => new Date().toISOString().slice(0,10);

function setSyncStatus(msg){
  document.getElementById("syncStatus").textContent = msg || "";
}
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

/* =========================================================
   Shared DB payload
   ========================================================= */
function CAR_buildPayload(){
  return {
    rescue_info: LS.get("rescue_info", {name:"Cartmills Animal Rescue", email:"", notes:""}),
    animals: LS.get("animals", []),
    fosters: LS.get("fosters", []),
    vets: LS.get("vets", []),
    pounds: LS.get("pounds", []),
    calendar: LS.get("calendar", []),
    expenses: LS.get("expenses", [])
  };
}
function CAR_applyPayload(payload){
  if (!payload) return;
  Object.keys(payload).forEach(k => localStorage.setItem(k, JSON.stringify(payload[k])));
}

function CAR_loadShared(){
  return new Promise((resolve, reject) => {
    const cbName = "CAR_cb_" + Date.now();
    window[cbName] = (resp) => {
      try{
        if (!resp || !resp.ok) throw new Error(resp?.error || "Load failed");
        CAR_applyPayload(resp.payload || {});
        setSyncStatus("Loaded shared data.");
        resolve(true);
      } catch(e){
        reject(e);
      } finally {
        try { delete window[cbName]; } catch {}
        script.remove();
      }
    };

    const url = `${CAR_WEBAPP_URL}?action=load&slug=${encodeURIComponent(CAR_SLUG)}&token=${encodeURIComponent(CAR_TOKEN)}&callback=${encodeURIComponent(cbName)}`;
    const script = document.createElement("script");
    script.src = url;
    script.onerror = () => reject(new Error("Load failed (bad URL/token/deploy access)"));
    document.head.appendChild(script);
  });
}

let CAR_saveTimer = null;
function CAR_scheduleSave(){
  clearTimeout(CAR_saveTimer);
  CAR_saveTimer = setTimeout(CAR_saveNow, 800);
}

function CAR_saveNow(){
  // POST via hidden iframe/form to avoid CORS issues
  const payloadText = JSON.stringify(CAR_buildPayload());

  let iframe = document.getElementById("carSaveFrame");
  if (!iframe){
    iframe = document.createElement("iframe");
    iframe.id = "carSaveFrame";
    iframe.name = "carSaveFrame";
    iframe.style.display = "none";
    document.body.appendChild(iframe);
  }

  let form = document.getElementById("carSaveForm");
  if (!form){
    form = document.createElement("form");
    form.id = "carSaveForm";
    form.method = "POST";
    form.target = "carSaveFrame";
    form.action = CAR_WEBAPP_URL;
    form.style.display = "none";
    document.body.appendChild(form);
  }

  form.innerHTML = `
    <input name="action" value="save" />
    <input name="slug" value="${escapeAttr(CAR_SLUG)}" />
    <input name="token" value="${escapeAttr(CAR_TOKEN)}" />
    <input name="payload" />
  `;
  form.querySelector('input[name="payload"]').value = payloadText;
  form.submit();
  setSyncStatus("Saved to shared DB.");
}

/* =========================================================
   Login + permissions (stored locally per device)
   ========================================================= */
const AUTH = {
  usersKey: "car_users_v1",
  sessionKey: "car_session_v1",

  async sha256(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  },

  async ensureDefaults(){
    let users = LS.get(this.usersKey, []);
    if (users.length) return;
    users = [{
      email:"admin", display:"Admin", role:"admin",
      pwHash: await this.sha256("admin"),
      mustChange:false,
      permissions:["*"]
    }];
    localStorage.setItem(this.usersKey, JSON.stringify(users));
  },

  current(){
    const email = SS.get(this.sessionKey, "");
    if (!email) return null;
    const users = LS.get(this.usersKey, []);
    return users.find(u => (u.email||"").toLowerCase() === String(email).toLowerCase()) || null;
  },

  isAdmin(){
    const u = this.current();
    return !!u && u.role === "admin";
  },

  can(section){
    const u = this.current();
    if (!u) return false;
    if (u.role === "admin") return true;
    if (Array.isArray(u.permissions) && u.permissions.includes("*")) return true;
    return Array.isArray(u.permissions) && u.permissions.includes(section);
  },

  showLogin(){
    document.getElementById("loginOverlay").classList.add("show");
    document.getElementById("loginForm").style.display = "";
    document.getElementById("pwChange").style.display = "none";
    document.getElementById("adminArea").style.display = "none";
  },

  showPwChange(){
    document.getElementById("loginOverlay").classList.add("show");
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("pwChange").style.display = "";
    document.getElementById("adminArea").style.display = "none";
  },

  hideOverlay(){
    document.getElementById("loginOverlay").classList.remove("show");
  },

  async login(email, pw){
    email = (email||"").trim();
    if (!email || !pw) return alert("Enter email and password.");
    const users = LS.get(this.usersKey, []);
    const u = users.find(x => (x.email||"").toLowerCase() === email.toLowerCase());
    if (!u) return alert("User not found.");
    const h = await this.sha256(pw);
    if (h !== u.pwHash) return alert("Incorrect password.");

    SS.set(this.sessionKey, u.email);

    if (u.mustChange && u.role !== "admin"){
      this.showPwChange();
      return;
    }
    this.hideOverlay();
    this.applyNav();
    renderAll();
  },

  async changeMyPassword(p1, p2){
    const u = this.current();
    if (!u) return;
    if (!p1 || p1.length < 6) return alert("Password must be at least 6 characters.");
    if (p1 !== p2) return alert("Passwords do not match.");

    const users = LS.get(this.usersKey, []);
    const idx = users.findIndex(x => (x.email||"").toLowerCase() === (u.email||"").toLowerCase());
    if (idx === -1) return;

    users[idx].pwHash = await this.sha256(p1);
    users[idx].mustChange = false;
    localStorage.setItem(this.usersKey, JSON.stringify(users));

    this.hideOverlay();
    this.applyNav();
    alert("Password updated.");
  },

  logout(){
    SS.del(this.sessionKey);
    this.showLogin();
  },

  applyNav(){
    document.querySelectorAll("#nav button[data-section]").forEach(btn=>{
      const key = btn.dataset.section;
      const ok = this.can(key);
      btn.style.display = ok ? "" : "none";
      btn.disabled = !ok;
    });
  },

  async upsertStaff(email, display){
    if (!this.isAdmin()) return alert("Admin only.");
    email = (email||"").trim().toLowerCase();
    if (!email) return alert("Email required.");
    const users = LS.get(this.usersKey, []);
    const idx = users.findIndex(u => (u.email||"").toLowerCase() === email);
    const existing = idx>=0 ? users[idx] : null;
    const perms = ["dashboard","animals_list","animals_add","fosters","vets","pounds","calendar","accounting","rescue"];
    const staff = {
      email,
      display: display || email,
      role:"staff",
      pwHash: existing ? existing.pwHash : await this.sha256("Helper123"),
      mustChange: existing ? existing.mustChange : true,
      permissions: perms
    };
    if (idx>=0) users[idx]=staff; else users.push(staff);
    localStorage.setItem(this.usersKey, JSON.stringify(users));
    alert("Staff saved. Default password is Helper123 (forced change).");
    this.renderAdminArea();
  },

  async resetStaff(email){
    if (!this.isAdmin()) return alert("Admin only.");
    email = (email||"").trim().toLowerCase();
    const users = LS.get(this.usersKey, []);
    const idx = users.findIndex(u => (u.email||"").toLowerCase() === email);
    if (idx===-1) return alert("User not found.");
    if (users[idx].role === "admin") return alert("Not for admin.");
    users[idx].pwHash = await this.sha256("Helper123");
    users[idx].mustChange = true;
    localStorage.setItem(this.usersKey, JSON.stringify(users));
    alert("Reset to Helper123 (forced change).");
    this.renderAdminArea();
  },

  deleteUser(email){
    if (!this.isAdmin()) return alert("Admin only.");
    email = (email||"").trim().toLowerCase();
    if (email === "admin") return alert("Cannot delete admin.");
    if (!confirm("Delete " + email + " ?")) return;
    const users = LS.get(this.usersKey, []);
    localStorage.setItem(this.usersKey, JSON.stringify(users.filter(u => (u.email||"").toLowerCase() !== email)));
    this.renderAdminArea();
  },

  renderAdminArea(){
    const box = document.getElementById("adminArea");
    if (!this.isAdmin()){
      box.style.display = "none";
      return;
    }
    const users = LS.get(this.usersKey, []).filter(u=>u.email!=="admin");
    box.style.display = "";
    box.innerHTML = `
      <div class="hr"></div>
      <div class="muted"><b>Admin: Create staff logins</b></div>
      <div class="row" style="margin-top:8px">
        <div class="field md"><label>Staff email</label><input id="admEmail" placeholder="staff@cartmills.org"></div>
        <div class="field md"><label>Display name</label><input id="admDisplay" placeholder="Helper"></div>
        <div class="field md" style="display:flex;align-items:end;gap:10px">
          <button class="btn primary" id="admSave">Add/Update</button>
          <button class="btn ghost" id="admReset">Reset PW</button>
        </div>
      </div>
      <div class="list" style="margin-top:10px">
        ${users.map(u=>`
          <div class="item" style="display:flex;justify-content:space-between;gap:12px;align-items:center">
            <div>
              <h4 style="margin:0">${escapeHtml(u.email)}</h4>
              <div class="muted">${escapeHtml(u.display||"")} â€¢ must change: ${u.mustChange?"yes":"no"}</div>
            </div>
            <div class="btnrow" style="margin:0">
              <button class="btn ghost" onclick="AUTH.resetStaff('${escapeAttr(u.email)}')">Reset PW</button>
              <button class="btn ghost" onclick="AUTH.deleteUser('${escapeAttr(u.email)}')">Delete</button>
            </div>
          </div>
        `).join("") || `<div class="item"><div class="muted">No staff yet.</div></div>`}
      </div>
    `;
    setTimeout(()=>{
      const save = document.getElementById("admSave");
      const reset = document.getElementById("admReset");
      if (save) save.onclick = ()=> AUTH.upsertStaff(document.getElementById("admEmail").value, document.getElementById("admDisplay").value);
      if (reset) reset.onclick = ()=> AUTH.resetStaff(document.getElementById("admEmail").value);
    }, 0);
  }
};

/* =========================================================
   Navigation
   ========================================================= */
function setPageTitle(title, hint){
  document.getElementById("pageTitle").textContent = title;
  document.getElementById("pageHint").textContent = hint || "";
}
function showSection(key){
  // gate
  if (!AUTH.current()){
    AUTH.showLogin();
    return;
  }
  if (!AUTH.can(key)){
    alert("Access denied: " + key);
    return;
  }

  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById("section-" + key);
  if (!el) return alert("Section not found: " + key);
  el.classList.add("active");

  document.querySelectorAll("#nav button").forEach(b=>b.classList.remove("active"));
  const btn = document.querySelector(`#nav button[data-section="${key}"]`);
  if (btn) btn.classList.add("active");

  const map = {
    dashboard:["Dashboard","Shared database via Google Sheets."],
    animals_list:["Animals â€“ List","View / edit all animals."],
    animals_add:["Animals â€“ Add","Add a new animal record."],
    fosters:["Fosters","Foster carers and capacity."],
    vets:["Vets","Vet clinic list."],
    pounds:["Pounds","Pounds and euthanasia dates."],
    calendar:["Calendar","Reminders and bookings."],
    accounting:["Accounting","Simple expense tracking."],
    rescue:["Rescue Info","Branding + contact info."]
  };
  const t = map[key] || [key,""];
  setPageTitle(t[0], t[1]);
}

document.getElementById("nav").addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-section]");
  if (!btn) return;
  showSection(btn.dataset.section);
});

/* =========================================================
   Data model + render
   ========================================================= */
function getNextAnimalCode(species){
  const animals = LS.get("animals", []);
  const prefix = species === "dog" ? "D" : "C";
  let max = 0;
  animals.forEach(a=>{
    if (typeof a.code === "string" && a.code.startsWith(prefix)){
      const n = parseInt(a.code.slice(1),10);
      if (!isNaN(n)) max = Math.max(max,n);
    }
  });
  return prefix + String(max+1).padStart(4,"0");
}

function renderDashboard(){
  const animals = LS.get("animals", []);
  document.getElementById("dashTotal").textContent = String(animals.length);
  document.getElementById("dashFoster").textContent = String(animals.filter(a=>a.location==="foster").length);
  document.getElementById("dashAdopted").textContent = String(animals.filter(a=>a.location==="adopted").length);

  const newest = animals.slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)).slice(0,10);
  const box = document.getElementById("dashNewest");
  box.innerHTML = newest.length ? newest.map(a=>`
    <div class="item" style="display:flex;justify-content:space-between;gap:12px;align-items:center">
      <div>
        <h4 style="margin:0">${escapeHtml(a.code)} â€¢ ${escapeHtml(a.name||"Unnamed")}</h4>
        <div class="muted">${escapeHtml(a.species)} â€¢ ${escapeHtml(a.location||"")} â€¢ rescued ${escapeHtml(a.dateRescued||"")}</div>
      </div>
      <button class="btn ghost" onclick="openEdit('${escapeAttr(a.id)}')">Edit</button>
    </div>
  `).join("") : `<div class="item"><div class="muted">No animals yet.</div></div>`;
}

function renderAnimals(){
  const animals = LS.get("animals", []).slice().sort((a,b)=> new Date(a.dateRescued||0) - new Date(b.dateRescued||0));
  const box = document.getElementById("animalsList");
  box.innerHTML = animals.length ? animals.map(a=>`
    <div class="item" style="display:flex;justify-content:space-between;gap:12px;align-items:center">
      <div>
        <h4 style="margin:0">${escapeHtml(a.code)} â€¢ ${escapeHtml(a.name||"Unnamed")}</h4>
        <div class="muted">${escapeHtml(a.species)} â€¢ rescued ${escapeHtml(a.dateRescued||"")} â€¢ location ${escapeHtml(a.location||"")}</div>
      </div>
      <div class="btnrow" style="margin:0">
        <button class="btn ghost" onclick="openEdit('${escapeAttr(a.id)}')">Edit</button>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="muted">No animals yet.</div></div>`;
}

function openEdit(id){
  const animals = LS.get("animals", []);
  const a = animals.find(x=>x.id===id);
  if (!a) return alert("Animal not found.");
  const wrap = document.getElementById("editWrap");
  wrap.classList.remove("muted");
  wrap.innerHTML = `
    <div class="row">
      <div class="field md"><label>Code</label><input value="${escapeAttr(a.code||"")}" readonly></div>
      <div class="field md"><label>Species</label><input value="${escapeAttr(a.species||"")}" readonly></div>
      <div class="field md"><label>Name</label><input id="eName" value="${escapeAttr(a.name||"")}"></div>
      <div class="field md"><label>Date Rescued</label><input id="eRescued" type="date" value="${escapeAttr(a.dateRescued||"")}"></div>
      <div class="field md"><label>Sex</label>
        <select id="eSex">
          <option value="" ${!a.sex?"selected":""}>Selectâ€¦</option>
          <option value="male" ${a.sex==="male"?"selected":""}>Male</option>
          <option value="female" ${a.sex==="female"?"selected":""}>Female</option>
        </select>
      </div>
      <div class="field md"><label>Colour</label><input id="eColour" value="${escapeAttr(a.colour||"")}"></div>
      <div class="field md"><label>Location</label>
        <select id="eLocation">
          <option value="" ${!a.location?"selected":""}>Selectâ€¦</option>
          <option value="pound" ${a.location==="pound"?"selected":""}>Pound</option>
          <option value="foster" ${a.location==="foster"?"selected":""}>Foster</option>
          <option value="adopted" ${a.location==="adopted"?"selected":""}>Adopted</option>
          <option value="transport" ${a.location==="transport"?"selected":""}>Transport</option>
        </select>
      </div>
      <div class="field full"><label>Notes</label><textarea id="eNotes">${escapeHtml(a.notes||"")}</textarea></div>
    </div>
    <div class="btnrow">
      <button class="btn primary" onclick="saveEdit('${escapeAttr(a.id)}')">Save</button>
      <button class="btn danger" onclick="deleteAnimal('${escapeAttr(a.id)}')">Delete</button>
    </div>
  `;
  showSection("animals_edit");
}

function saveEdit(id){
  const animals = LS.get("animals", []);
  const idx = animals.findIndex(x=>x.id===id);
  if (idx===-1) return;
  animals[idx].name = document.getElementById("eName").value.trim();
  animals[idx].dateRescued = document.getElementById("eRescued").value || todayISO();
  animals[idx].sex = document.getElementById("eSex").value;
  animals[idx].colour = document.getElementById("eColour").value.trim();
  animals[idx].location = document.getElementById("eLocation").value;
  animals[idx].notes = document.getElementById("eNotes").value.trim();
  LS.set("animals", animals);
  alert("Saved.");
  renderAll();
  showSection("animals_list");
}

function deleteAnimal(id){
  if (!confirm("Delete this animal?")) return;
  const animals = LS.get("animals", []).filter(x=>x.id!==id);
  LS.set("animals", animals);
  renderAll();
  showSection("animals_list");
}

function renderFosters(){
  const fosters = LS.get("fosters", []);
  const box = document.getElementById("fosterList");
  box.innerHTML = fosters.length ? fosters.map(f=>{
    const remaining = Math.max(0,(f.capacity||0)-(f.hosting||0));
    const badge = remaining<=0
      ? `<span class="pill" style="background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)">Full</span>`
      : `<span class="pill">Space: ${remaining}</span>`;
    return `
      <div class="item" style="display:flex;justify-content:space-between;gap:12px;align-items:center">
        <div>
          <h4 style="margin:0">${escapeHtml(f.name||"Unnamed foster")}</h4>
          <div class="muted">${escapeHtml(f.phone||"")} â€¢ cap ${f.capacity||0} â€¢ hosting ${f.hosting||0}</div>
          <div class="muted">${escapeHtml(f.address||"")}</div>
        </div>
        ${badge}
      </div>
    `;
  }).join("") : `<div class="item"><div class="muted">No fosters yet.</div></div>`;
}

function renderVets(){
  const vets = LS.get("vets", []);
  const box = document.getElementById("vetList");
  box.innerHTML = vets.length ? vets.map(v=>`
    <div class="item">
      <h4 style="margin:0">${escapeHtml(v.name||"")}</h4>
      <div class="muted">${escapeHtml(v.phone||"")}</div>
      <div class="muted">${escapeHtml(v.address||"")}</div>
    </div>
  `).join("") : `<div class="item"><div class="muted">No vets yet.</div></div>`;
}

function renderPounds(){
  const pounds = LS.get("pounds", []);
  const box = document.getElementById("poundList");
  box.innerHTML = pounds.length ? pounds.map(p=>`
    <div class="item">
      <h4 style="margin:0">${escapeHtml(p.name||"")}</h4>
      <div class="muted">${escapeHtml(p.contact||"")} â€¢ euth day: ${escapeHtml(p.euth||"")}</div>
      <div class="muted">${escapeHtml(p.address||"")}</div>
    </div>
  `).join("") : `<div class="item"><div class="muted">No pounds yet.</div></div>`;
}

function renderCalendar(){
  const cal = LS.get("calendar", []).slice().sort((a,b)=> new Date(a.date)-new Date(b.date));
  const box = document.getElementById("calendarList");
  box.innerHTML = cal.length ? cal.map(c=>{
    const badge = c.status==="completed"
      ? `<span class="pill" style="background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35)">Completed</span>`
      : `<span class="pill" style="background:rgba(43,108,176,.15);border-color:rgba(43,108,176,.35)">Booked</span>`;
    return `
      <div class="item" style="display:flex;justify-content:space-between;gap:12px;align-items:center">
        <div>
          <h4 style="margin:0">${escapeHtml(c.date||"")}</h4>
          <div class="muted">${escapeHtml(c.note||"")}</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          ${badge}
          <button class="btn ghost" onclick="removeCal('${escapeAttr(c.id)}')">Remove</button>
        </div>
      </div>
    `;
  }).join("") : `<div class="item"><div class="muted">No calendar entries yet.</div></div>`;
}
function removeCal(id){
  LS.set("calendar", LS.get("calendar", []).filter(x=>x.id!==id));
  renderCalendar();
}

function renderExpenses(){
  const exp = LS.get("expenses", []).slice().sort((a,b)=> new Date(a.date)-new Date(b.date));
  const box = document.getElementById("expenseList");
  let total = 0;
  box.innerHTML = exp.length ? exp.map(e=>{
    total += e.amt||0;
    return `
      <div class="item" style="display:flex;justify-content:space-between;gap:12px;align-items:center">
        <div>
          <h4 style="margin:0">${escapeHtml(e.date)} â€¢ ${escapeHtml(e.cat)}</h4>
          <div class="muted">${escapeHtml(e.desc)} â€” $${(e.amt||0).toFixed(2)}</div>
        </div>
        <button class="btn ghost" onclick="removeExpense('${escapeAttr(e.id)}')">Remove</button>
      </div>
    `;
  }).join("") : `<div class="item"><div class="muted">No expenses yet.</div></div>`;
  document.getElementById("accTotal").textContent = total.toFixed(2);
}
function removeExpense(id){
  LS.set("expenses", LS.get("expenses", []).filter(x=>x.id!==id));
  renderExpenses();
}

function loadBrand(){
  const info = LS.get("rescue_info", {name:"Cartmills Animal Rescue", email:"", notes:""});
  document.getElementById("brandName").textContent = info.name || "Cartmills Animal Rescue";
  document.title = (info.name || "Cartmills Animal Rescue") + " â€“ Tracker";
  document.getElementById("rName").value = info.name || "";
  document.getElementById("rEmail").value = info.email || "";
  document.getElementById("rNotes").value = info.notes || "";
}

function renderAll(){
  loadBrand();
  renderDashboard();
  renderAnimals();
  renderFosters();
  renderVets();
  renderPounds();
  renderCalendar();
  renderExpenses();
  AUTH.renderAdminArea();
}

/* =========================================================
   Buttons / events
   ========================================================= */
document.getElementById("btnTheme").onclick = ()=>{
  const html = document.documentElement;
  const cur = html.getAttribute("data-theme") || "light";
  html.setAttribute("data-theme", cur==="dark" ? "light" : "dark");
  localStorage.setItem("theme", JSON.stringify(html.getAttribute("data-theme")));
};

document.getElementById("btnSync").onclick = async ()=>{
  try{
    setSyncStatus("Loading sharedâ€¦");
    await CAR_loadShared();
    renderAll();
    setSyncStatus("Loaded shared.");
  } catch(e){
    alert("Shared load failed: " + e.message);
    setSyncStatus("Shared load failed.");
  }
};

document.getElementById("logoutBtn").onclick = (e)=>{ e.preventDefault(); AUTH.logout(); };

document.getElementById("aSpecies").addEventListener("change", ()=>{
  const species = document.getElementById("aSpecies").value;
  document.getElementById("aCode").value = species ? getNextAnimalCode(species) : "";
});

document.getElementById("btnSaveAnimal").onclick = ()=>{
  const species = document.getElementById("aSpecies").value;
  if (!species) return alert("Select species.");
  const code = document.getElementById("aCode").value;
  if (!code) return alert("Code missing.");
  const animals = LS.get("animals", []);
  if (animals.some(a=>a.code===code)) return alert("That code already exists. Change species to regenerate.");
  animals.push({
    id: uid(),
    code,
    species,
    name: document.getElementById("aName").value.trim(),
    dateRescued: document.getElementById("aRescued").value || todayISO(),
    sex: document.getElementById("aSex").value,
    colour: document.getElementById("aColour").value.trim(),
    location: document.getElementById("aLocation").value,
    notes: document.getElementById("aNotes").value.trim(),
    createdAt: Date.now()
  });
  LS.set("animals", animals);
  alert("Saved.");
  document.getElementById("btnClearAnimal").click();
  renderAll();
  showSection("animals_list");
};

document.getElementById("btnClearAnimal").onclick = ()=>{
  ["aSpecies","aCode","aName","aRescued","aSex","aColour","aLocation","aNotes"].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.value = "";
  });
  document.getElementById("aRescued").value = todayISO();
};

document.getElementById("btnSaveFoster").onclick = ()=>{
  const fosters = LS.get("fosters", []);
  fosters.push({
    id: uid(),
    name: document.getElementById("fName").value.trim(),
    phone: document.getElementById("fPhone").value.trim(),
    address: document.getElementById("fAddress").value.trim(),
    capacity: Number(document.getElementById("fCap").value||0),
    hosting: Number(document.getElementById("fHosting").value||0)
  });
  LS.set("fosters", fosters);
  alert("Saved.");
  renderFosters();
};

document.getElementById("btnSaveVet").onclick = ()=>{
  const vets = LS.get("vets", []);
  vets.push({
    id: uid(),
    name: document.getElementById("vName").value.trim(),
    phone: document.getElementById("vPhone").value.trim(),
    address: document.getElementById("vAddress").value.trim()
  });
  LS.set("vets", vets);
  alert("Saved.");
  renderVets();
};

document.getElementById("btnSavePound").onclick = ()=>{
  const pounds = LS.get("pounds", []);
  const name = document.getElementById("pName").value.trim();
  const euth = document.getElementById("pEuth").value;
  pounds.push({
    id: uid(),
    name,
    contact: document.getElementById("pContact").value.trim(),
    address: document.getElementById("pAddress").value.trim(),
    euth
  });
  LS.set("pounds", pounds);

  // add reminder day before
  if (euth){
    const cal = LS.get("calendar", []);
    const d = new Date(euth);
    d.setDate(d.getDate()-1);
    cal.push({ id: uid(), date: d.toISOString().slice(0,10), note: `Reminder: Call pound (${name}) before euthanasia day.`, status:"booked" });
    LS.set("calendar", cal);
  }
  alert("Saved.");
  renderPounds(); renderCalendar();
};

document.getElementById("btnAddCal").onclick = ()=>{
  const date = document.getElementById("cDate").value;
  const note = document.getElementById("cNote").value.trim();
  if (!date || !note) return alert("Date and note required.");
  const cal = LS.get("calendar", []);
  cal.push({ id: uid(), date, note, status: document.getElementById("cStatus").value });
  LS.set("calendar", cal);
  renderCalendar();
};

document.getElementById("btnAddExpense").onclick = ()=>{
  const date = document.getElementById("accDate").value || todayISO();
  const desc = document.getElementById("accDesc").value.trim();
  const cat = document.getElementById("accCat").value;
  const amt = parseFloat(document.getElementById("accAmt").value);
  if (!desc || !isFinite(amt)) return alert("Description and amount required.");
  const exp = LS.get("expenses", []);
  exp.push({ id: uid(), date, desc, cat, amt: Number(amt.toFixed(2)) });
  LS.set("expenses", exp);
  renderExpenses();
};

document.getElementById("btnSaveRescue").onclick = ()=>{
  const info = {
    name: document.getElementById("rName").value.trim() || "Cartmills Animal Rescue",
    email: document.getElementById("rEmail").value.trim(),
    notes: document.getElementById("rNotes").value.trim()
  };
  LS.set("rescue_info", info);
  loadBrand();
  alert("Saved.");
};

document.getElementById("btnExport").onclick = ()=>{
  const payload = CAR_buildPayload();
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "cartmills_backup.json";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

document.getElementById("btnImport").onclick = ()=>{
  const inp = document.getElementById("importFile");
  inp.onchange = async ()=>{
    const f = inp.files[0];
    if (!f) return;
    try{
      const data = JSON.parse(await f.text());
      Object.keys(data).forEach(k => localStorage.setItem(k, JSON.stringify(data[k])));
      alert("Imported.");
      renderAll();
    }catch(e){
      alert("Import failed: " + e.message);
    }finally{
      inp.value = "";
    }
  };
  inp.click();
};

/* Login buttons */
document.getElementById("btnLogin").onclick = ()=> AUTH.login(document.getElementById("loginEmail").value, document.getElementById("loginPw").value);
document.getElementById("btnChangePw").onclick = ()=> AUTH.changeMyPassword(document.getElementById("pw1").value, document.getElementById("pw2").value);

/* =========================================================
   Boot
   ========================================================= */
async function boot(){
  // theme
  const theme = (()=>{ try{return JSON.parse(localStorage.getItem("theme")||'"light"');}catch{return "light";} })();
  document.documentElement.setAttribute("data-theme", theme);

  document.getElementById("aRescued").value = todayISO();
  document.getElementById("accDate").value = todayISO();
  document.getElementById("cDate").value = todayISO();

  await AUTH.ensureDefaults();

  // try shared load first (non-fatal)
  try{
    setSyncStatus("Loading sharedâ€¦");
    await CAR_loadShared();
  } catch(e){
    setSyncStatus("Shared load failed (using local).");
  }

  const u = AUTH.current();
  if (!u){
    AUTH.showLogin();
    return;
  }
  if (u.mustChange && u.role !== "admin"){
    AUTH.showPwChange();
    return;
  }
  AUTH.applyNav();
  renderAll();
  showSection("dashboard");
}

boot();
</script>

</body>
</html>

